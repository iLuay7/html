<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>بيانات التحويل والدفع</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <style>
        /* fallback to keep background dark even لو تعطل تحميل style.css */
        html,
        body {
            margin: 0;
            min-height: 100%;
            background: linear-gradient(135deg, #0a1a3a, #021122);
            color: #ffffff;
        }

        /* force vertical stacked rectangular bank boxes */
        .bank-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 14px !important;
            align-items: stretch !important;
            max-width: 760px;
            margin: 0 auto 32px auto;
            padding: 12px 16px;
        }

        .bank-box {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            background: rgba(6, 16, 39, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 14px !important;
            padding: 18px 18px !important;
            gap: 10px !important;
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35) !important;
            width: 100% !important;
            box-sizing: border-box !important;
            color: #e5edff !important;
        }

        .bank-box .box-icon {
            font-weight: 700;
            font-size: 1.05rem;
            padding-inline-end: 12px;
        }

        .bank-box .box-name {
            font-size: 0.95rem;
            color: #cdd6f0;
            text-align: center;
        }

        /* ensure responsive on small screens */
        @media (max-width: 420px) {
            .bank-grid {
                padding: 8px 10px;
            }

            .bank-box {
                padding: 14px;
            }
        }
    </style>
</head>

<body>

    <!-- copy sound (coin / jump style) -->
    <audio id="copy-sound" preload="auto">
        <source src="explosion.mp3" type="audio/mpeg" />
    </audio>

    <!-- sun glow -->
    <div class="sun"></div>

    <!-- bubbles -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <!-- Header -->
    <div class="header-section">
        <h1>بيانات التحويل والدفع</h1>
        <div class="subtitle">اختر مزود الخدمة وانسخ بيانات الحساب لإتمام تحويلك بسرعة.</div>
    </div>

    <!-- Bank Grid -->
    <div class="bank-grid" id="bank-grid">
        <div class="bank-box" data-target="modal-rajhi" role="button" tabindex="0">
            <div class="box-icon">الراجحي</div>
            <div class="box-name">حساب مصرف الراجحي</div>
        </div>
        <div class="bank-box" data-target="modal-alinma" role="button" tabindex="0">
            <div class="box-icon">الإنماء</div>
            <div class="box-name">حساب بنك الإنماء</div>
        </div>
        <div class="bank-box" data-target="modal-albilad" role="button" tabindex="0">
            <div class="box-icon">البلاد</div>
            <div class="box-name">حساب بنك البلاد</div>
        </div>
        <div class="bank-box" data-target="modal-barq" role="button" tabindex="0">
            <div class="box-icon">برق</div>
            <div class="box-name">محفظة برق (Barq)</div>
        </div>
        <div class="bank-box" data-target="modal-stc" role="button" tabindex="0">
            <div class="box-icon">STC</div>
            <div class="box-name">STC Pay</div>
        </div>
        <div class="bank-box" data-target="modal-mobily" role="button" tabindex="0">
            <div class="box-icon">موبايلي</div>
            <div class="box-name">Mobily Pay</div>
        </div>
        <div class="bank-box" data-target="modal-d360" role="button" tabindex="0">
            <div class="box-icon">D360</div>
            <div class="box-name">D360 Bank</div>
        </div>
    </div>

    <!-- Backdrop -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>

    <!-- Modals -->
    <!-- Rajhi -->
    <div class="card" id="modal-rajhi" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">حساب مصرف الراجحي</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-rajhi">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-rajhi" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-rajhi">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-rajhi" type="button">نسخ</button>
        </div>
    </div>

    <!-- Alinma -->
    <div class="card" id="modal-alinma" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">حساب بنك الإنماء</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-alinma">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-alinma" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-alinma">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-alinma" type="button">نسخ</button>
        </div>
    </div>

    <!-- Albilad -->
    <div class="card" id="modal-albilad" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">حساب بنك البلاد</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-albilad">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-albilad" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-albilad">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-albilad" type="button">نسخ</button>
        </div>
    </div>

    <!-- Barq -->
    <div class="card" id="modal-barq" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">محفظة برق (Barq)</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-barq">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-barq" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-barq">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-barq" type="button">نسخ</button>
        </div>
    </div>

    <!-- STC Pay -->
    <div class="card" id="modal-stc" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">STC Pay</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-stc">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-stc" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-stc">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-stc" type="button">نسخ</button>
        </div>
    </div>

    <!-- Mobily Pay -->
    <div class="card" id="modal-mobily" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">Mobily Pay</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-mobily">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-mobily" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-mobily">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-mobily" type="button">نسخ</button>
        </div>
    </div>

    <!-- D360 -->
    <div class="card" id="modal-d360" aria-hidden="true">
        <button class="close-modal" type="button">&times;</button>
        <div class="bank-header">
            <div class="bank-title">D360 Bank</div>
        </div>
        <div class="row">
            <span class="label">الوصف:</span>
            <span class="value">اكتب وصف التحويل هنا إذا رغبت.</span>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الآيبان:</span>
                <span class="value" id="iban-d360">SA0000000000000000000000</span>
            </div>
            <button class="copy-btn" data-copy="iban-d360" type="button">نسخ</button>
        </div>
        <div class="row copy-row">
            <div class="copy-text">
                <span class="label">رقم الحساب:</span>
                <span class="value" id="acc-d360">00000000000000</span>
            </div>
            <button class="copy-btn" data-copy="acc-d360" type="button">نسخ</button>
        </div>
    </div>

    <!-- Footer Note -->
    <div class="footer-note">
        <p class="note">
            ملاحظة: تأكد من مطابقة رقم الحساب والآيبان قبل التحويل. أبلغ فوراً إذا وجدت أي خطأ.
            <br />
            للاستخدام الآمن ننصح بكتابة وصف واضح للتحويل والتواصل عبر القنوات الرسمية للحصول على التأكيد.
        </p>
    </div>

    <!-- comments section -->
    <div class="comments-card">
        <div class="comments-header">
            <h2 class="comments-title">آراؤكم تهمنا</h2>
            <div class="comments-subtitle">شارك تقييمك وتعليقك السريع لنحسن التجربة.</div>
        </div>

        <form id="comment-form" class="comment-form">
            <div class="form-row">
                <label for="comment-name">الاسم</label>
                <input id="comment-name" type="text" placeholder="مثال: محمد علي" />
            </div>

            <div class="form-row">
                <label>التقييم</label>
                <div class="stars" id="rating-stars">
                    <span class="star" data-value="1">&#9733;</span>
                    <span class="star" data-value="2">&#9733;</span>
                    <span class="star" data-value="3">&#9733;</span>
                    <span class="star" data-value="4">&#9733;</span>
                    <span class="star" data-value="5">&#9733;</span>
                </div>
            </div>

            <div class="form-row">
                <label for="comment-text">التعليق</label>
                <textarea id="comment-text" rows="3" placeholder="اكتب رأيك باختصار حول تجربة التحويل..." required></textarea>
            </div>

            <button type="submit" class="submit-comment-btn">إرسال التعليق</button>
        </form>

        <div id="comments-status" class="comments-status" aria-live="polite"></div>

        <div id="comments-list" class="comments-list">
            <p class="no-comments">لا توجد تعليقات بعد.</p>
        </div>
    </div>

    <script>
        // Modal Logic (open/close with accessibility support)
        const backdrop = document.getElementById("backdrop");
        const bankBoxes = document.querySelectorAll(".bank-box");
        const closeButtons = document.querySelectorAll(".close-modal");
        const cards = document.querySelectorAll(".card");

        function openModal(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                backdrop.classList.add("active");
                backdrop.setAttribute("aria-hidden", "false");
                card.classList.add("active");
                card.setAttribute("aria-hidden", "false");
                const closeBtn = card.querySelector(".close-modal");
                if (closeBtn) {
                    closeBtn.focus();
                }
            }
        }

        function closeModal() {
            backdrop.classList.remove("active");
            backdrop.setAttribute("aria-hidden", "true");
            cards.forEach(c => {
                c.classList.remove("active");
                c.setAttribute("aria-hidden", "true");
            });
            const firstBox = document.querySelector(".bank-box");
            if (firstBox) firstBox.focus();
        }

        bankBoxes.forEach(box => {
            box.addEventListener("click", () => {
                const target = box.getAttribute("data-target");
                openModal(target);
            });
            // keyboard support (Enter / Space)
            box.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " " || e.key === "Spacebar") {
                    e.preventDefault();
                    const target = box.getAttribute("data-target");
                    openModal(target);
                }
            });
        });

        // Ensure each modal has an account row even if missing in markup
        (function ensureAccountRows() {
            cards.forEach(function (card) {
                const key = card.id.replace(/^modal-/, '');
                const accId = `acc-${key}`;
                if (!document.getElementById(accId)) {
                    const row = document.createElement('div');
                    row.className = 'row copy-row';

                    const copyText = document.createElement('div');
                    copyText.className = 'copy-text';

                    const label = document.createElement('span');
                    label.className = 'label';
                    label.textContent = 'رقم الحساب:';

                    const value = document.createElement('span');
                    value.className = 'value';
                    value.id = accId;
                    value.textContent = 'أضف رقم الحساب هنا';

                    copyText.appendChild(label);
                    copyText.appendChild(value);

                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.type = 'button';
                    btn.setAttribute('data-copy', accId);
                    btn.textContent = 'نسخ';

                    row.appendChild(copyText);
                    row.appendChild(btn);

                    card.appendChild(row);
                }
            });
        })();

        closeButtons.forEach(btn => btn.addEventListener("click", closeModal));
        backdrop.addEventListener("click", closeModal);
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeModal();
        });

        // copy buttons + sound
        const copySound = document.getElementById("copy-sound");

        document.querySelectorAll(".copy-btn").forEach(function (btn) {
            btn.addEventListener("click", function () {
                const targetId = btn.getAttribute("data-copy");
                const el = document.getElementById(targetId);
                if (!el) return;
                const text = el.textContent.trim();
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(function () {
                        showCopiedState(btn);
                        playCopySound();
                    }).catch(function () {
                        playCopySound();
                    });
                } else {
                    const tempInput = document.createElement("input");
                    tempInput.value = text;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    showCopiedState(btn);
                    playCopySound();
                }
            });
        });

        function showCopiedState(btn) {
            const originalText = btn.textContent;
            btn.textContent = "تم النسخ!";
            btn.classList.add("copied");
            setTimeout(function () {
                btn.textContent = originalText;
                btn.classList.remove("copied");
            }, 1200);
        }

        function playCopySound() {
            if (!copySound) return;
            try {
                copySound.currentTime = 0;
                copySound.play().catch(function () { });
            } catch (e) { }
        }

        // comments (Google Forms backend)
        const commentsApiUrl = "https://script.google.com/macros/s/AKfycbxOB1GoZp3FRysVzPDRvbTaJw8hPS8_lT2lz9C_4FiKrWNOWZPsQHrkBkitlp9WdrPv/exec"; // جاهز للنشر عبر Apps Script
        const commentsListEl = document.getElementById("comments-list");
        const commentsStatusEl = document.getElementById("comments-status");
        let comments = [];
        const LOCAL_COMMENTS_KEY = "comments_cache";

        function loadLocalComments() {
            try {
                const raw = localStorage.getItem(LOCAL_COMMENTS_KEY);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function persistLocalComments(list) {
            try {
                localStorage.setItem(LOCAL_COMMENTS_KEY, JSON.stringify(list || []));
            } catch (e) { }
        }

        function setCommentsStatus(message, isError = false) {
            if (!commentsStatusEl) return;
            commentsStatusEl.textContent = message || "";
            commentsStatusEl.classList.toggle("error", Boolean(isError));
        }

        function renderComments() {
            if (!commentsListEl) return;

            commentsListEl.innerHTML = "";

            if (!comments || comments.length === 0) {
                commentsListEl.innerHTML = '<p class="no-comments">لا توجد تعليقات بعد.</p>';
                return;
            }

            comments.forEach(function (c) {
                const item = document.createElement("div");
                item.className = "comment-item";

                const header = document.createElement("div");
                header.className = "comment-header";

                const nameEl = document.createElement("div");
                nameEl.className = "comment-name";
                nameEl.textContent = c.name || "مستخدم بدون اسم";

                const starsEl = document.createElement("div");
                starsEl.className = "comment-stars";
                const rating = Number(c.rating || 0);
                let starsText = "";
                for (let i = 1; i <= 5; i++) {
                    starsText += i <= rating ? "★" : "☆";
                }
                starsEl.textContent = starsText;

                header.appendChild(nameEl);
                header.appendChild(starsEl);

                const body = document.createElement("div");
                body.className = "comment-text";
                body.textContent = c.text || "";

                item.appendChild(header);
                item.appendChild(body);
                commentsListEl.appendChild(item);
            });
        }

        async function fetchComments() {
            if (!commentsApiUrl || commentsApiUrl.includes("REPLACE_WITH_YOUR_DEPLOYMENT_ID")) {
                setCommentsStatus("تنبيه: رابط Google Apps Script غير مهيأ، لن يتم حفظ التعليقات.", true);
                renderComments();
                return;
            }
            setCommentsStatus("جارٍ تحميل التعليقات...");
            try {
                const response = await fetch(commentsApiUrl, { method: "GET", cache: "no-store" });
                if (response.redirected || response.status === 401 || response.status === 403) {
                    throw new Error("يجب تسجيل الدخول بحساب Google لعرض التعليقات.");
                }
                if (!response.ok) throw new Error(`حدث خطأ أثناء تحميل التعليقات (${response.status})`);
                const data = await response.json();
                comments = Array.isArray(data.comments) ? data.comments : [];
                renderComments();
                persistLocalComments(comments);
                setCommentsStatus(comments.length ? "" : "لا توجد تعليقات بعد.");
            } catch (error) {
                console.error(error);
                setCommentsStatus(error.message || "حدث خطأ أثناء تحميل التعليقات، حاول لاحقاً.", true);
            }
        }

        async function sendCommentToGoogle(payload) {
            if (!commentsApiUrl || commentsApiUrl.includes("REPLACE_WITH_YOUR_DEPLOYMENT_ID")) {
                throw new Error("رابط Google Apps Script غير مهيأ.");
            }
            try {
                const response = await fetch(commentsApiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" }, // text/plain لتفادي طلب preflight
                    body: JSON.stringify(payload)
                });
                if (response.redirected || response.status === 401 || response.status === 403) {
                    throw new Error("يجب تسجيل الدخول بحساب Google لإرسال التعليق.");
                }
                if (!response.ok) {
                    throw new Error(`حدث خطأ أثناء إرسال التعليق (${response.status})`);
                }
                const result = await response.json().catch(() => ({}));
                if (result.success === false) {
                    throw new Error(result.message || "تعذر إرسال التعليق.");
                }
                return result;
            } catch (primaryErr) {
                console.warn("Primary POST failed, trying no-cors fallback", primaryErr);
                // fallback: no-cors يسمح بالوصول بدون preflight لكن بدون قراءة الرد
                await fetch(commentsApiUrl, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return { success: true, offlineFallback: true };
            }
        }

        let currentRating = 5;
        const starElems = document.querySelectorAll(".star");
        function updateStarView() {
            starElems.forEach(function (star) {
                const value = Number(star.getAttribute("data-value"));
                star.classList.toggle("selected", value <= currentRating);
            });
        }
        starElems.forEach(function (star) {
            star.addEventListener("click", function () {
                const value = Number(star.getAttribute("data-value"));
                currentRating = value;
                updateStarView();
            });
        });
        updateStarView();

        // load cached comments locally first
        comments = loadLocalComments();
        renderComments();
        fetchComments();

        const commentForm = document.getElementById("comment-form");
        const commentNameInput = document.getElementById("comment-name");
        const commentTextInput = document.getElementById("comment-text");
        const submitBtn = document.querySelector(".submit-comment-btn");
        commentForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const name = (commentNameInput.value || "").trim() || "مستخدم بدون اسم";
            const text = (commentTextInput.value || "").trim();
            if (!text) {
                setCommentsStatus("الرجاء كتابة تعليق قبل الإرسال.", true);
                return;
            }
            const newComment = {
                name: name,
                text: text,
                rating: currentRating || 0
            };
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.dataset.originalText = submitBtn.textContent;
                submitBtn.textContent = "جاري إرسال تعليقك...";
            }
            try {
                setCommentsStatus("");
                const result = await sendCommentToGoogle(newComment);
                setCommentsStatus("تم إرسال تعليقك، شكراً!");
                commentForm.reset();
                currentRating = 5;
                updateStarView();
                const stamped = { ...newComment, timestamp: new Date().toISOString() };
                if (result && result.offlineFallback) {
                    // fallback: أضف التعليق محلياً لأن الرد غير مقروء مع no-cors
                    comments = [...comments, stamped];
                    renderComments();
                    persistLocalComments(comments);
                } else {
                    await fetchComments();
                    if (!comments.find(c => c.text === stamped.text && c.name === stamped.name)) {
                        comments = [...comments, stamped];
                        renderComments();
                        persistLocalComments(comments);
                    }
                }
            } catch (err) {
                console.error(err);
                setCommentsStatus(err.message || "حدث خطأ أثناء إرسال التعليق، حاول مرة أخرى.", true);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = submitBtn.dataset.originalText || "إرسال التعليق";
                }
            }
        });
    </script>
</body>

</html>
